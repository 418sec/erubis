<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=EUC-JP">
  <title>プログラマーのための eRuby 入門 (車輪の再発明編)</title>
  <meta name="generator" content="kwaser">
  <meta http-equiv="Content-Style-Type" content="text/css">

  <style type="text/css">
   <!--

body		{
		background-color:#FFFFFF;
		}
.mainbody	{
		color:#333333;
		line-height:150%;
		}

a:link, a:active, a:hover {
		color:#CC6600;
		}
a:visited	{
		color:#DD9900;
		}

p		{
		color:#333333;
		line-height:150%;
		}

pre		{
		width: 100%;
		line-height:130%;
		white-space:pre;
		}
.program	{
		border-style:solid;
		border-width:2;
		border-color:#6699FF;
		color:#333333;
		background-color:#DDEEFF;
		padding:8 9 8 9;
		margin:0;
		word-break:keep-all;
		}
.terminal	{
		border-style:solid;
		border-width:1;
		border-color:#FFFFFF;
		color:#333333;
		background-color:#E0E0E0;
		padding:9 10 9 10;
		margin:0;
		word-break:keep-all;
		}
.output		{
		border-style:solid;
		border-width:2;
		border-color:#CCCCCC;
		color:#333333;
		background-color:#FFFFFF;
		padding:8 9 8 9;
		margin:0;
		word-break:keep-all;
		}
.program_caption {
		}
.terminal_caption {
		}
.output_caption {
		}


ul,ol,dl	{
	 	Xmargin:0px;
		Xpadding:0px;
		color:#333333;
		line-height:130%;
		}

.dt2, .dt3	{
		font-weight:bold;
		}

.table1		{
		padding:2;
		color:#333333;
		background-color:#DDDDCC;
		line-height:130%;
		Xborder-width:1;
		Xborder-style:solid;
		Xborder-color:#FFFFFF;
		margin:5;
		}
.th1, .th2	{
		padding:1;
		color:#333333;
		Xbackground-color:#DDDDCC;
		background-color:#CCCCBB;
		line-height:130%;
		}
.td1, .th2	{
		padding:1;
		color:#333333;
		background-color:#EEEEDD;
		line-height:130%;
		}
.caption1, .caption2 {
		Xfont-size:x-small;
		color:#333333;
		}
.table2		{
		padding:1;
		color:#333333;
		background-color:#DDDDCC;
		line-height:130%;
		Xborder-width:1;
		Xborder-style:solid;
		Xborder-color:#FFFFFF;
		margin:5;
		}

h1, .chapter, .doctitle {
	  	Xfont-size:20pt;
		color:#333333;
	 	font-weight:bold;
		padding:30 0 10 0;
		}
h2, .section	{
		Xfont-size:16pt;
		color:#333333;
		font-weight:bold;
		border-style:solid;
		border-color:#6699FF;
		border-width:0 0 2 30;
		padding:10 20 0 5;
		}
h3, .subsection	{
		Xfont-size:12pt;
		color:#333333;
		font-weight:bold;
		border-style:solid;
		border-color:#6699FF;
		border-width: 0 0 0 15;
		padding: 10 20 0 5;
		}

.em		{
		font-weight:bold;
		}

.toc		{
		font-size:small;
		line-height:100%;
		}
.footnote	{
		font-size:small;
		}
.note		{
		background-color:#FFFFDD;
		border-style:solid;
		border-width:0 1 0 1;
		border-color:#DDDD66;
		color:#333300;
		Xfont-size:small;
		line-height:120%;
		padding: 5 20 5 20;
		}
.figure		{
		Xborder-width:1;
		Xborder-color:#DDDD66;
		Xwhite-space:pre;
		}

   -->
  </style>

 </head>
 <body>

  <blockquote>
   <div class="mainbody">
    <div align="left"><h1>プログラマーのための eRuby 入門 (車輪の再発明編)</h1></div>

    <div align="left">
      last update: $Date$<br>
    </div>

<a name="最初の実装"></a>
<h2 class="section1">最初の実装</h2>
<a name="eruby1.rb"></a>
<div class="program_caption">
eruby1.rb</div>
<pre class="program">##
## eRuby の実装
##
class Eruby

  ## eRuby 形式の文字列を受け取る
  def initialize(input)
    @input = input
    @src = compile(@input)
  end
  attr_reader :src

  ## 実行した結果 (文字列) を返す
  def result(binding=TOPLEVEL_BINDING)
    filename = '(eruby)'
    eval @src, binding, filename
  end

  private

  ## eRuby 形式の文字列を Ruby コードに変換する
  def compile(input=@input)
    src = "_out = ''; "
    regexp = /(.*?)&lt;%(=?)(.*?)%&gt;/m
    input.scan(regexp) do |text, indicator, code|
      ## テキストを処理
      text.each_line do |line|
        src &lt;&lt; "_out &lt;&lt; #{line.dump}" &lt;&lt; (line[-1] == ?\n ? "\n" : "; ")
      end

      ## 埋め込み Ruby コードを処理
      if indicator == '='  # &lt;%= %&gt; の場合
        src &lt;&lt; "_out &lt;&lt; (#{code}).to_s; "
      else                 # &lt;%  %&gt; の場合
        code.each_line { |line| src &lt;&lt; line }
        src &lt;&lt; "; " unless code[-1] == ?\n
      end
    end

    ## 残りのテキストを処理
    rest = $' || input
    rest.each_line do |line|
      src &lt;&lt; "_out &lt;&lt; #{line.dump}" &lt;&lt; (line[-1] == ?\n ? "\n" : "; ")
    end

    src &lt;&lt; "_out\n"
    return src
  end

end
</pre>
<a name="example1.rb"></a>
<div class="program_caption">
example1.rb</div>
<pre class="program">list = ['aaa', 'bbb', 'ccc']

input = &lt;&lt;END
&lt;ul&gt;
 &lt;% for item in list %&gt;
  &lt;li&gt;&lt;%= item %&gt;&lt;/li&gt;
 &lt;% end %&gt;
&lt;/ul&gt;
END

require 'eruby1'
eruby = Eruby.new(input)
puts "--- source ---"
puts eruby.src
puts "--- result ---"
puts eruby.result
</pre>
<div class="output_caption">
output</div>
<pre class="output">--- source ---
_out = ''; _out &lt;&lt; "&lt;ul&gt;\n"
_out &lt;&lt; " ";  for item in list ; _out &lt;&lt; "\n"
_out &lt;&lt; "  &lt;li&gt;"; _out &lt;&lt; ( item ).to_s; _out &lt;&lt; "&lt;/li&gt;\n"
_out &lt;&lt; " ";  end ; _out &lt;&lt; "\n"
_out &lt;&lt; "&lt;/ul&gt;\n"
_out
--- result ---
&lt;ul&gt;
 
  &lt;li&gt;aaa&lt;/li&gt;
 
  &lt;li&gt;bbb&lt;/li&gt;
 
  &lt;li&gt;ccc&lt;/li&gt;
 
&lt;/ul&gt;
</pre>
<br>


<a name="子クラスでの拡張をしやすくする"></a>
<h2 class="section1">子クラスでの拡張をしやすくする</h2>
<a name="eruby2.rb"></a>
<div class="program_caption">
eruby2.rb</div>
<pre class="program">##
## eRuby の実装
##
class Eruby

  ## eRuby 形式の文字列を受け取る
  def initialize(input)
    @input = input
    @src = compile(@input)
  end
  attr_reader :src

  ## 実行した結果 (文字列) を返す
  def result(binding=TOPLEVEL_BINDING)
    filename = '(eruby)'
    eval @src, binding, filename
  end

  private

  ## eRuby 形式の文字列を Ruby コードに変換する
  def compile(input=@input)
    <strong>src = ""</strong>
    <strong>initialize_src(src)</strong>
    regexp = /(.*?)&lt;%(=?)(.*?)%&gt;/m
    input.scan(regexp) do |text, indicator, code|
      ## テキストを処理
      <strong>add_src_text(src, text)</strong>

      ## 埋め込み Ruby コードを処理
      if indicator == '='  # &lt;%= %&gt; の場合
        <strong>add_src_expr(src, code)</strong>
      else                 # &lt;%  %&gt; の場合
        <strong>add_src_code(src, code)</strong>
      end
    end

    ## 残りのテキストを処理
    rest = $' || input
    <strong>add_src_text(src, rest)</strong>

    <strong>finalize_src(src)</strong>
    return src
  end

  <strong>protected</strong>

  <strong>def initialize_src(src)</strong>
    <strong>src &lt;&lt; "_out = ''; "</strong>
  <strong>end</strong>

  <strong>def add_src_text(src, text)</strong>
    <strong>return if text.empty?</strong>
    <strong>text.each_line do |line|</strong>
      <strong>src &lt;&lt; "_out &lt;&lt; #{line.dump}" &lt;&lt; (line[-1] == ?\n ? "\n" : "; ")</strong>
    <strong>end</strong>
  <strong>end</strong>

  <strong>def add_src_expr(src, code)</strong>
    <strong>src &lt;&lt; "_out &lt;&lt; (#{code}).to_s; "</strong>
  <strong>end</strong>

  <strong>def add_src_code(src, code)</strong>
    <strong>code.each_line { |line| src &lt;&lt; line }</strong>
    <strong>src &lt;&lt; "; " unless code[-1] == ?\n</strong>
  <strong>end</strong>

  <strong>def finalize_src(src)</strong>
    <strong>src &lt;&lt; "_out\n"</strong>
  <strong>end</strong>

end
</pre>
<a name="stdout-eruby.rb"></a>
<div class="program_caption">
stdout-eruby.rb : 標準出力を使う Eruby</div>
<pre class="program">##
## 文字列ではなく標準出力を使う Eruby
## (「&lt;% print expr %&gt;」が使えるようになる)
##
class StdoutEruby &lt; Eruby

  def initialize_src(src)
    src &lt;&lt; "_out = $stdout; "   ## 文字列のかわりに標準出力を使う
  end

  def finalize_src(src)
    src &lt;&lt; "nil\n"
  end

end
</pre>
<a name="fast-eruby.rb"></a>
<div class="program_caption">
fast-eruby.rb : 高速化した Eruby</div>
<pre class="program">##
## 実行速度を高速化した Eruby
##
class FastEruby &lt; Eruby

  def add_src_text(src, text)
    return if text.empty?
    src &lt;&lt; "_out &lt;&lt; #{text.dump}" &lt;&lt; "; "
    src &lt;&lt; ("\n" * text.count("\n"))
  end

end
</pre>
<a name="example2.rb"></a>
<div class="program_caption">
example2.rb</div>
<pre class="program">list = ['aaa', 'bbb', 'ccc']

input = &lt;&lt;END
&lt;table&gt;
 &lt;% for item in list %&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;%= item %&gt;&lt;/td&gt;
  &lt;/tr&gt;
 &lt;% end %&gt;
&lt;/table&gt;
END

require 'eruby2'
eruby = Eruby.new(input)
puts "--- source (Eruby) ---"
puts eruby.src

require 'fast-eruby'
fasteruby = FastEruby.new(input)
puts "--- source (FastEruby) ---"
puts fasteruby.src
</pre>
<div class="output_caption">
output</div>
<pre class="output">--- source (Eruby) ---
_out = ''; _out &lt;&lt; "&lt;table&gt;\n"
_out &lt;&lt; " ";  for item in list ; _out &lt;&lt; "\n"
_out &lt;&lt; "  &lt;tr&gt;\n"
_out &lt;&lt; "    &lt;td&gt;"; _out &lt;&lt; ( item ).to_s; _out &lt;&lt; "&lt;/td&gt;\n"
_out &lt;&lt; "  &lt;/tr&gt;\n"
_out &lt;&lt; " ";  end ; _out &lt;&lt; "\n"
_out &lt;&lt; "&lt;/table&gt;\n"
_out
--- source (FastEruby) ---
_out = ''; _out &lt;&lt; "&lt;table&gt;\n "; 
 for item in list ; _out &lt;&lt; "\n  &lt;tr&gt;\n    &lt;td&gt;"; 

_out &lt;&lt; ( item ).to_s; _out &lt;&lt; "&lt;/td&gt;\n  &lt;/tr&gt;\n "; 

 end ; _out &lt;&lt; "\n&lt;/table&gt;\n"; 

_out
</pre>
<br>


<a name="余分な空白を出力しない"></a>
<h2 class="section1">余分な空白を出力しない</h2>
<a name="eruby3.rb"></a>
<div class="program_caption">
eruby3.rb</div>
<pre class="program">##
## eRuby の実装
##
class Eruby

  ## eRuby 形式の文字列を受け取る
  def initialize(input)
    @input = input
    @src = compile(@input)
  end
  attr_reader :src

  ## 実行した結果 (文字列) を返す
  def result(binding=TOPLEVEL_BINDING)
    filename = '(eruby)'
    eval @src, binding, filename
  end

  private

  ## eRuby 形式の文字列を Ruby コードに変換する
  def compile(input=@input)
    src = ""
    initialize_src(src)
    regexp = /(.*?)<strong>(^[ \t]*)?</strong>&lt;%(=?)(.*?)%&gt;<strong>([ \t]*\r?\n)?</strong>/m
    input.scan(regexp) do |text, <strong>head_space,</strong> indicator, code<strong>, tail_space</strong>|
      <strong>## * &lt;%= %&gt; のときは、何もしない</strong>
      <strong>## * &lt;% %&gt; のときは、</strong>
      <strong>##    * 前後が空白だけのときは、その空白を削除</strong>
      <strong>##    * そうでないときは、何もしない（空白を残す）</strong>
      <strong>flag_trim = indicator != '=' &amp;&amp; head_space &amp;&amp; tail_space</strong>

      ## テキストを処理
      add_src_text(src, text)

      <strong>## 前の空白を処理</strong>
      <strong>unless flag_trim</strong>
        <strong>add_src_text(src, head_space) if head_space</strong>
      <strong>end</strong>

      ## 埋め込み Ruby コードを処理
      if indicator == '='  # &lt;%= %&gt; の場合
        add_src_expr(src, code)
      else                 # &lt;%  %&gt; の場合
        <strong>## 改行を含めた前後の空白をコードに足す</strong>
        <strong>code = "#{head_space}#{code}#{tail_space}" if flag_trim</strong>
        add_src_code(src, code)
      end

      <strong>## 後ろの空白を処理</strong>
      <strong>unless flag_trim</strong>
        <strong>add_src_text(src, tail_space) if tail_space</strong>
      <strong>end</strong>
    end

    ## 残りのテキストを処理
    rest = $' || input
    add_src_text(src, rest)

    finalize_src(src)
    return src
  end

  protected

  def initialize_src(src)
    src &lt;&lt; "_out = ''; "
  end

  def add_src_text(src, text)
    return if text.empty?
    text.each_line do |line|
      src &lt;&lt; "_out &lt;&lt; #{line.dump}" &lt;&lt; (line[-1] == ?\n ? "\n" : "; ")
    end
  end

  def add_src_expr(src, code)
    src &lt;&lt; "_out &lt;&lt; (#{code}).to_s; "
  end

  def add_src_code(src, code)
    code.each_line { |line| src &lt;&lt; line }
    src &lt;&lt; "; " unless code[-1] == ?\n
  end

  def finalize_src(src)
    src &lt;&lt; "_out\n"
  end

end
</pre>
<a name="example3.rb"></a>
<div class="program_caption">
example3.rb</div>
<pre class="program">list = ['aaa', 'bbb', 'ccc']

input = &lt;&lt;END
&lt;ul&gt;
 &lt;% for item in list %&gt;
  &lt;li&gt;
    &lt;%= item %&gt;
  &lt;/li&gt;
 &lt;% end %&gt;
&lt;/ul&gt;
END

require 'eruby3'
eruby = Eruby.new(input)
puts "--- source ---"
puts eruby.src
puts "--- result ---"
puts eruby.result
</pre>
<div class="output_caption">
output</div>
<pre class="output">--- source ---
_out = ''; _out &lt;&lt; "&lt;ul&gt;\n"
  for item in list 
_out &lt;&lt; "  &lt;li&gt;\n"
_out &lt;&lt; "    "; _out &lt;&lt; ( item ).to_s; _out &lt;&lt; "\n"
_out &lt;&lt; "  &lt;/li&gt;\n"
  end 
_out &lt;&lt; "&lt;/ul&gt;\n"
_out
--- result ---
&lt;ul&gt;
  &lt;li&gt;
    aaa
  &lt;/li&gt;
  &lt;li&gt;
    bbb
  &lt;/li&gt;
  &lt;li&gt;
    ccc
  &lt;/li&gt;
&lt;/ul&gt;
</pre>
<br>


<a name="文字列をエスケープする"></a>
<h2 class="section1">文字列をエスケープする</h2>
<a name="eruby4.rb"></a>
<div class="program_caption">
eruby4.rb</div>
<pre class="program">##
## eRuby の実装
##
class Eruby

  ## eRuby 形式の文字列を受け取る
  def initialize(input)
    @input = input
    @src = compile(@input)
  end
  attr_reader :src

  ## 実行した結果 (文字列) を返す
  def result(binding=TOPLEVEL_BINDING)
    filename = '(eruby)'
    eval @src, binding, filename
  end

  private

  ## eRuby 形式の文字列を Ruby コードに変換する
  def compile(input=@input)
    src = ""
    initialize_src(src)
    regexp = /(.*?)(^[ \t]*)?&lt;%(<strong>=*</strong>)(.*?)%&gt;([ \t]*\r?\n)?/m
    input.scan(regexp) do |text, head_space, indicator, code, tail_space|
      ## * &lt;%= %&gt; のときは、何もしない
      ## * &lt;% %&gt; のときは、
      ##    * 前後が空白だけのときは、その空白を削除
      ##    * そうでないときは、何もしない（空白を残す）
      flag_trim = <strong>indicator.empty?</strong> &amp;&amp; head_space &amp;&amp; tail_space

      ## テキストを処理
      add_src_text(src, text)

      ## 前の空白を処理
      unless flag_trim
        add_src_text(src, head_space) if head_space
      end

      ## 埋め込み Ruby コードを処理
      if <strong>!indicator.empty?</strong>  # &lt;%= %&gt; の場合
        add_src_expr(src, code<strong>, indicator</strong>)
      else                  # &lt;%  %&gt; の場合
        ## 改行を含めた前後の空白をコードに足す
        code = "#{head_space}#{code}#{tail_space}" if flag_trim
        add_src_code(src, code)
      end

      ## 後ろの空白を処理
      unless flag_trim
        add_src_text(src, tail_space) if tail_space
      end
    end

    ## 残りのテキストを処理
    rest = $' || input
    add_src_text(src, rest)

    finalize_src(src)
    return src
  end

  protected

  def initialize_src(src)
    src &lt;&lt; "_out = ''; "
  end

  def add_src_text(src, text)
    return if text.empty?
    text.each_line do |line|
      src &lt;&lt; "_out &lt;&lt; #{line.dump}" &lt;&lt; (line[-1] == ?\n ? "\n" : "; ")
    end
  end

  def add_src_expr(src, code, indicator)
    src &lt;&lt; "_out &lt;&lt; (#{code}).to_s; "
  end

  def add_src_code(src, code)
    code.each_line { |line| src &lt;&lt; line }
    src &lt;&lt; "; " unless code[-1] == ?\n
  end

  def finalize_src(src)
    src &lt;&lt; "_out\n"
  end

end
</pre>
<a name="xml-eruby.rb"></a>
<div class="program_caption">
xml-eruby.rb</div>
<pre class="program">##
## サニタイズを行う Eruby
## * &lt;%= %&gt;  はサニタイズして出力
## * &lt;%== %&gt; はサニタイズせずそのまま出力
##
class XmlEruby &lt; Eruby

  def self.escape(obj)
    str = obj.to_s.dup
    #str = obj.to_s
    #str = str.dup if obj.__id__ == str.__id__
    str.gsub!(/&amp;/, '&amp;amp;')
    str.gsub!(/&lt;/, '&amp;lt;')
    str.gsub!(/&gt;/, '&amp;gt;')
    str.gsub!(/"/, '&amp;quot;')
    return str
  end

  <strong>def add_src_expr(src, code, indicator)</strong>
    <strong>if indicator == '='</strong>
      <strong>src &lt;&lt; "_out &lt;&lt; XmlEruby.escape(#{code}); "</strong>
    <strong>else</strong>
      <strong>super</strong>
    <strong>end</strong>
  <strong>end</strong>

end
</pre>
<a name="example4.rb"></a>
<div class="program_caption">
example4.rb</div>
<pre class="program">list = ['&lt;aaa&gt;', 'b&amp;b', '"ccc"']

input = &lt;&lt;END
&lt;ul&gt;
 &lt;% for item in list %&gt;
  &lt;li&gt;&lt;%= item %&gt;&lt;/li&gt;
  &lt;li&gt;&lt;%== item %&gt;&lt;/li&gt;
 &lt;% end %&gt;
&lt;/ul&gt;
END

require 'eruby4'
require 'xml-eruby'
eruby = XmlEruby.new(input)
puts "--- source ---"
puts eruby.src
puts "--- result ---"
puts eruby.result
</pre>
<div class="output_caption">
output</div>
<pre class="output">--- source ---
_out = ''; _out &lt;&lt; "&lt;ul&gt;\n"
  for item in list 
_out &lt;&lt; "  &lt;li&gt;"; _out &lt;&lt; XmlEruby.escape( item ); _out &lt;&lt; "&lt;/li&gt;\n"
_out &lt;&lt; "  &lt;li&gt;"; _out &lt;&lt; ( item ).to_s; _out &lt;&lt; "&lt;/li&gt;\n"
  end 
_out &lt;&lt; "&lt;/ul&gt;\n"
_out
--- result ---
&lt;ul&gt;
  &lt;li&gt;&amp;lt;aaa&amp;gt;&lt;/li&gt;
  &lt;li&gt;&lt;aaa&gt;&lt;/li&gt;
  &lt;li&gt;b&amp;amp;b&lt;/li&gt;
  &lt;li&gt;b&amp;b&lt;/li&gt;
  &lt;li&gt;&amp;quot;ccc&amp;quot;&lt;/li&gt;
  &lt;li&gt;"ccc"&lt;/li&gt;
&lt;/ul&gt;
</pre>
<br>


<a name="埋め込み用パターンを変更可能にする"></a>
<h2 class="section1">埋め込み用パターンを変更可能にする</h2>
<a name="eruby5.rb"></a>
<div class="program_caption">
eruby5.rb</div>
<pre class="program">##
## eRuby の実装
##
class Eruby

  ## eRuby 形式の文字列を受け取る
  def initialize(input<strong>, options={}</strong>)
    @input = input
    <strong>@options = options</strong>
    <strong>@pattern = options[:pattern] || '&lt;% %&gt;'</strong>
    @src = compile(@input)
  end
  attr_reader :src

  ## 実行した結果 (文字列) を返す
  def result(binding=TOPLEVEL_BINDING)
    filename = '(eruby)'
    eval @src, binding, filename
  end

  private

  ## eRuby 形式の文字列を Ruby コードに変換する
  def compile(input=@input)
    src = ""
    initialize_src(src)
    <strong>prefix, postfix = @pattern.split()   # 埋め込みパターン</strong>
    regexp = /(.*?)(^[ \t]*)?<strong>#{prefix}</strong>(=*)(.*?)<strong>#{postfix}</strong>([ \t]*\r?\n)?/m
    input.scan(regexp) do |text, head_space, indicator, code, tail_space|
      ## * &lt;%= %&gt; のときは、何もしない
      ## * &lt;% %&gt; のときは、
      ##    * 前後が空白だけのときは、その空白を削除
      ##    * そうでないときは、何もしない（空白を残す）
      flag_trim = indicator.empty? &amp;&amp; head_space &amp;&amp; tail_space

      ## テキストを処理
      add_src_text(src, text)

      ## 前の空白を処理
      unless flag_trim
        add_src_text(src, head_space) if head_space
      end

      ## 埋め込み Ruby コードを処理
      if !indicator.empty?  # &lt;%= %&gt; の場合
        add_src_expr(src, code, indicator)
      else                  # &lt;%  %&gt; の場合
        ## 改行を含めた前後の空白をコードに足す
        code = "#{head_space}#{code}#{tail_space}" if flag_trim
        add_src_code(src, code)
      end

      ## 後ろの空白を処理
      unless flag_trim
        add_src_text(src, tail_space) if tail_space
      end
    end

    ## 残りのテキストを処理
    rest = $' || input
    add_src_text(src, rest)

    finalize_src(src)
    return src
  end

  protected

  def initialize_src(src)
    src &lt;&lt; "_out = ''; "
  end

  def add_src_text(src, text)
    return if text.empty?
    text.each_line do |line|
      src &lt;&lt; "_out &lt;&lt; #{line.dump}" &lt;&lt; (line[-1] == ?\n ? "\n" : "; ")
    end
  end

  def add_src_expr(src, code, indicator)
    src &lt;&lt; "_out &lt;&lt; (#{code}).to_s; "
  end

  def add_src_code(src, code)
    code.each_line { |line| src &lt;&lt; line }
    src &lt;&lt; "; " unless code[-1] == ?\n
  end

  def finalize_src(src)
    src &lt;&lt; "_out\n"
  end

end
</pre>
<a name="example5.rb"></a>
<div class="program_caption">
example5.rb</div>
<pre class="program">list = ['aaa', 'bbb', 'ccc']

input = &lt;&lt;END
&lt;ul&gt;
 &lt;!--% for item in list %--&gt;
  &lt;li&gt;&lt;!--%= item %--&gt;&lt;/li&gt;
 &lt;!--% end %--&gt;
&lt;/ul&gt;
END

require 'eruby5'
eruby = Eruby.new(input, :pattern=&gt;'&lt;!--% %--&gt;')
                              # or '&lt;(?:!--)% %(?:--)&gt;'
puts "--- source ---"
print eruby.src
puts "--- result ---"
print eruby.result()
</pre>
<div class="output_caption">
output</div>
<pre class="output">--- source ---
_out = ''; _out &lt;&lt; "&lt;ul&gt;\n"
  for item in list 
_out &lt;&lt; "  &lt;li&gt;"; _out &lt;&lt; ( item ).to_s; _out &lt;&lt; "&lt;/li&gt;\n"
  end 
_out &lt;&lt; "&lt;/ul&gt;\n"
_out
--- result ---
&lt;ul&gt;
  &lt;li&gt;aaa&lt;/li&gt;
  &lt;li&gt;bbb&lt;/li&gt;
  &lt;li&gt;ccc&lt;/li&gt;
&lt;/ul&gt;
</pre>
<br>


<a name="コンテキストを指定できるようにする"></a>
<h2 class="section1">コンテキストを指定できるようにする</h2>
<a name="eruby6.rb"></a>
<div class="program_caption">
eruby6.rb</div>
<pre class="program">##
## eRuby の実装
##
class Eruby

  ## eRuby 形式の文字列を受け取る
  def initialize(input, options={})
    @input = input
    @options = options
    @pattern = options[:pattern] || '&lt;% %&gt;'
    @src = compile(@input)
  end
  attr_reader :src

  ## 実行した結果 (文字列) を返す
  def result(binding=TOPLEVEL_BINDING)
    filename = '(eruby)'
    eval @src, binding, filename
  end
  
  <strong>## コンテキストを指定して result() を呼び出す</strong>
  <strong>def evaluate(_context={})</strong>
    <strong>_evalstr = ''</strong>
    <strong>_context.keys.each do |key|</strong>
      <strong>_evalstr &lt;&lt; "#{key.to_s} = _context[#{key.inspect}]\n"</strong>
    <strong>end</strong>
    <strong>eval _evalstr</strong>
    <strong>return result(binding())</strong>
  <strong>end</strong>

  private

  ## eRuby 形式の文字列を Ruby コードに変換する
  def compile(input=@input)
    src = ""
    initialize_src(src)
    prefix, postfix = @pattern.split()   # 埋め込みパターン
    regexp = /(.*?)(^[ \t]*)?#{prefix}(=*)(.*?)#{postfix}([ \t]*\r?\n)?/m
    input.scan(regexp) do |text, head_space, indicator, code, tail_space|
      ## * &lt;%= %&gt; のときは、何もしない
      ## * &lt;% %&gt; のときは、
      ##    * 前後が空白だけのときは、その空白を削除
      ##    * そうでないときは、何もしない（空白を残す）
      flag_trim = indicator.empty? &amp;&amp; head_space &amp;&amp; tail_space

      ## テキストを処理
      add_src_text(src, text)

      ## 前の空白を処理
      unless flag_trim
        add_src_text(src, head_space) if head_space
      end

      ## 埋め込み Ruby コードを処理
      if !indicator.empty?  # &lt;%= %&gt; の場合
        add_src_expr(src, code, indicator)
      else                  # &lt;%  %&gt; の場合
        ## 改行を含めた前後の空白をコードに足す
        code = "#{head_space}#{code}#{tail_space}" if flag_trim
        add_src_code(src, code)
      end

      ## 後ろの空白を処理
      unless flag_trim
        add_src_text(src, tail_space) if tail_space
      end
    end

    ## 残りのテキストを処理
    rest = $' || input
    add_src_text(src, rest)

    finalize_src(src)
    return src
  end

  protected

  def initialize_src(src)
    src &lt;&lt; "_out = ''; "
  end

  def add_src_text(src, text)
    return if text.empty?
    text.each_line do |line|
      src &lt;&lt; "_out &lt;&lt; #{line.dump}" &lt;&lt; (line[-1] == ?\n ? "\n" : "; ")
    end
  end

  def add_src_expr(src, code, indicator)
    src &lt;&lt; "_out &lt;&lt; (#{code}).to_s; "
  end

  def add_src_code(src, code)
    code.each_line { |line| src &lt;&lt; line }
    src &lt;&lt; "; " unless code[-1] == ?\n
  end

  def finalize_src(src)
    src &lt;&lt; "_out\n"
  end

end
</pre>
<a name="example6.rb"></a>
<div class="program_caption">
example6.rb</div>
<pre class="program">## eRuby スクリプト
input = &lt;&lt;END
&lt;h2&gt;&lt;%= title %&gt;&lt;/h2&gt;
&lt;ul&gt;
 &lt;% for item in list %&gt;
  &lt;li&gt;&lt;%= item %&gt;&lt;/li&gt;
 &lt;% end %&gt;
&lt;/ul&gt;
END

## コンテキストオブジェクトを作成する。
## 変数名は文字列または Symbol で指定する。
## また YAML ファイルを読み込んでそれをコンテキストとして使ってもよい。
context = {}
context['title'] = "Context Example"
context[:list]   = ['aaa', 'bbb', 'ccc']

## eRuby を実行する
require 'eruby6'
eruby = Eruby.new(input)
print eruby.evaluate(context)
</pre>
<div class="output_caption">
output</div>
<pre class="output">&lt;h2&gt;Context Example&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;aaa&lt;/li&gt;
  &lt;li&gt;bbb&lt;/li&gt;
  &lt;li&gt;ccc&lt;/li&gt;
&lt;/ul&gt;
</pre>
<br>



   </div>
  </blockquote>

 </body>
</html>
